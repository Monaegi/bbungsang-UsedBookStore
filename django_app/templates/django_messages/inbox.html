{% load i18n %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/message.css' %}">
<p class="h1">받은 쪽지함</p>
  <table class="messages">
    <thead>
      <tr>
        <th>보내는 사람</th>
        <th>제목</th>
        <th>받은 날짜</th>
        <th>삭제</th>
      </tr>
    </thead>
    {% if message_list %}
    <tbody>
      {% for message in message_list %}
      <tr>
        <td>{{ message.sender.nickname }}</td>
        <td>
          {% if message.new %}<strong>{% endif %}
          {% if message.replied %}<em>{% endif %}
          <a class="detail" data-value="{{ message.id }}">{{ message.subject|truncatechars:9 }}</a>
          {% if message.replied %}</em>{% endif %}
          {% if message.new %}</strong>{% endif %}
        </td>
        <td>{{ message.sent_at|date:_("DATETIME_FORMAT") }}</td>
        <td>
          <a class="delBtn" data-value="{{ message.id }}">
            Delete
          </a>
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td style="color: #fafafa; font-size: 15px;" colspan="4">No messages</td>
      </tr>
    </tbody>
  </table>
{% endif %}

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript">

  // 쪽지 삭제
  $(".delBtn").click(function(e){
    var message_id = e.target.dataset.value;
    delMessage(message_id);
  });

  function delMessage(message_id){
    $.ajax({
      type: "GET",
      url: "http://localhost:8000/messages/delete/" + message_id,
      success: function (response) {
        $("#messageScreen").html(response);
      },
      error: function (request, status, error) {
        $("#messageScreen").html(error);
      }
    });
    event.preventDefault();
  }

  // 쪽지 내용 보기
  $(".detail").click(function(e){
    var message_id = e.target.dataset.value;
    viewMessage(message_id);
  });

  function viewMessage(message_id){
    $.ajax({
      type: "GET",
      url: "http://localhost:8000/messages/view/" + message_id,
      success: function (response) {
        $("#messageScreen").html(response);
      },
      error: function (request, status, error) {
        $("#messageScreen").html(error);
      }
    });
    event.preventDefault();
  }
</script>
